# 接口文档

### 接口文档

 用户模块（User）

|        接口路径         | 请求方法 |                        请求参数/示例                         |                          返回值示例                          |           状态码说明           |
| :---------------------: | :------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------: |
|     `/api/register`     |   POST   | `{ "username":"test", "password":"123456", "email":"test@example.com" }` | `{ "code":200, "data":{ "id":1, "username":"test", "balance":0.0, "status":0 } }` | 201: 创建成功, 400: 用户已存在 |
|      `/api/login`       |   POST   |         `{ "username":"test", "password":"123456" }`         |     `{ "code":200, "data":{ "token":"xxx", "role":0 } }`     |         401: 密码错误          |
|   `/api/user/balance`   |   GET    |                         无 (需Token)                         |               `{ "code":200, "data":1000.0 }`                |           200: 成功            |
|   `/api/admin/users`    |   GET    |                  `?status=0&page=1&size=10`                  | `{ "code":200, "data":{ "list":[ { "id":1, "username":"test", "status":0 } ], "total":100 } }` |       管理员权限校验403        |
| `/api/admin/users/{id}` |   PUT    |                   `{ "status":1 }` (封号)                    |                       `{ "code":200 }`                       |                                |

------

### **2. 航班模块（Flight）**

|         接口路径          | 请求方法 |                        请求参数/示例                         |                          返回值示例                          |    状态码说明     |
| :-----------------------: | :------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :---------------: |
|      `/api/flights`       |   GET    |        `?departure=上海&arrival=北京&date=2023-10-01`        | `{ "code":200, "data":[ { "id":1, "flightNumber":"CA123", "price":500.0, "seatsLeft":10 } ] }` |     200: 成功     |
|   `/api/admin/flights`    |   POST   | `{ "flightNumber":"CA123", "departure":"上海", "price":500.0, "seats":100 }` |             `{ "code":200, "data":{ "id":1 } }`              | 400: 参数校验失败 |
| `/api/admin/flights/{id}` |   PUT    |                     `{ "price":600.0 }`                      |                       `{ "code":200 }`                       |  404: 航班不存在  |

------

### **3. 订单模块（Order）**

|             接口路径             | 请求方法 |                        请求参数/示例                         |                          返回值示例                          |  状态码说明   |
| :------------------------------: | :------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :-----------: |
|        `/api/user/orders`        |   POST   | `{ "flightId":1, "passengerIds":[1], "seatType":"ECONOMY" }` | `{ "code":200, "data":{ "orderId":"20231001123456", "price":500.0 } }` | 400: 余票不足 |
| `/api/user/orders/{orderId}/pay` |   POST   |                `{ "paymentMethod":"ALIPAY" }`                | `{ "code":200, "data":{ "balance":500.0 } }` (返回用户最新余额) | 402: 余额不足 |
|   `/api/user/orders/{orderId}`   |  DELETE  |                  `{ "reason":"行程变更" }`                   | `{ "code":200, "data":{ "refundAmount":480.0 } }` (手续费20元) | 200: 退款成功 |
|       `/api/admin/orders`        |   GET    |                `?flightNumber=CA123&status=1`                | `{ "code":200, "data":[ { "id":1, "username":"test", "totalPrice":500.0 } ] }` |               |

------

### **4. 乘客模块（Passenger）**

|               接口路径               | 请求方法 |                    请求参数/示例                    |                          返回值示例                          |     状态码说明      |
| :----------------------------------: | :------: | :-------------------------------------------------: | :----------------------------------------------------------: | :-----------------: |
|        `/api/user/passengers`        |   GET    |                    无 (需Token)                     | `{ "code":200, "data":[ { "id":1, "name":"张三", "idCard":"310xxx..." } ] }` |                     |
|        `/api/user/passengers`        |   POST   | `{ "name":"张三", "idCard":"310xxx...", "type":0 }` |             `{ "code":200, "data":{ "id":1 } }`              | 400: 身份证格式错误 |
| `/api/user/passengers/{passengerId}` |  DELETE  |                         无                          |                       `{ "code":200 }`                       |   404: 乘客不存在   |

------

### **5. 座位模块（Seat）**

|            接口路径             | 请求方法 |             请求参数/示例             |                          返回值示例                          |  状态码说明   |
| :-----------------------------: | :------: | :-----------------------------------: | :----------------------------------------------------------: | :-----------: |
| `/api/flights/{flightId}/seats` |   GET    |            `?type=ECONOMY`            | `{ "code":200, "data":[ { "seatNumber":"A1", "isBooked":false } ] }` |               |
|       `/api/admin/seats`        |   POST   | `{ "flightId":1, "seatNumber":"A1" }` |             `{ "code":200 }` (标记座位为已预定)              | 409: 座位冲突 |

------

### **关键业务逻辑说明**

1. **订单退款**
   - 手续费计算规则：`退款金额 = 原价 - (当前时间 - 起飞时间) * 费率`
   - 示例：起飞前24小时退款，手续费5%；起飞前2小时退款，手续费20%。
2. **航班查询**
   - 返回值包含动态计算的 `seatsLeft`（余票数），由后台实时查询 `已预定座位表` 统计。
3. **权限控制**
   - 用户接口：需校验 `Token` 和 `role=0`
   - 管理员接口：需校验 `role=1` 并返回 `403` 无权限。
4. **数据一致性**
   - 创建订单时，会同时操作 `订单表` 和 `已预定座位表`（事务控制）。

